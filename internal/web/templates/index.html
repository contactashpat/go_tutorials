<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>String Visualiser</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 2rem;
      max-width: 960px;
      background-color: var(--bg);
      color: var(--fg);
      transition: background-color 0.3s ease, color 0.3s ease;
      --bg: #f7f7f9;
      --fg: #111;
      --card-bg: #fff;
      --card-border: #e2e8f0;
      --muted: #4b5563;
      --btn-bg: #2563eb;
      --btn-bg-disabled: #93c5fd;
      --btn-fg: #fff;
      --table-border: #e5e7eb;
      --table-head: #f3f4f6;
      --status-success-bg: #dcfce7;
      --status-success-fg: #065f46;
      --status-error-bg: #fee2e2;
      --status-error-fg: #991b1b;
    }
    body[data-theme="dark"] {
      --bg: #0f172a;
      --fg: #f8fafc;
      --card-bg: #1e293b;
      --card-border: #334155;
      --muted: #cbd5f5;
      --btn-bg: #38bdf8;
      --btn-bg-disabled: #7dd3fc;
      --btn-fg: #0f172a;
      --table-border: #334155;
      --table-head: #1d273a;
      --status-success-bg: #14532d;
      --status-success-fg: #d1fae5;
      --status-error-bg: #7f1d1d;
      --status-error-fg: #fecaca;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    p.lede {
      margin-top: 0;
      color: var(--muted);
    }
    .toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.75rem;
    }
    .toolbar button {
      background: transparent;
      border: 1px solid var(--card-border);
      color: var(--fg);
      padding: 0.4rem 0.8rem;
    }
    form {
      display: grid;
      gap: 0.75rem;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      margin-bottom: 1.5rem;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }
    textarea, select {
      font: inherit;
      padding: 0.75rem;
      border: 1px solid var(--card-border);
      background: transparent;
      color: var(--fg);
      border-radius: 6px;
      resize: vertical;
    }
    button {
      font: inherit;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 6px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    button:disabled {
      background: var(--btn-bg-disabled);
      cursor: not-allowed;
    }
    .status {
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: 1px solid transparent;
    }
    .status.error {
      background: var(--status-error-bg);
      color: var(--status-error-fg);
      border-color: rgba(0,0,0,0.05);
    }
    .status.success {
      background: var(--status-success-bg);
      color: var(--status-success-fg);
      border-color: rgba(0,0,0,0.05);
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    .results-table th,
    .results-table td {
      border: 1px solid var(--table-border);
      padding: 0.45rem;
      text-align: left;
      vertical-align: top;
    }
    .results-table th {
      background: var(--table-head);
      font-weight: 600;
    }
    .hidden {
      display: none;
    }
    .field-helper {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .results-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
    }
    .download-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .download-actions button {
      flex: none;
    }
    .copy-btn {
      background: transparent;
      color: var(--btn-bg);
      border: 1px dashed var(--card-border);
      padding: 0.2rem 0.4rem;
      font-size: 0.8rem;
      margin-top: 0.35rem;
      border-radius: 4px;
    }
    .copy-btn:disabled {
      opacity: 0.6;
    }
    .cell-content {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .cell-content small {
      color: var(--muted);
    }
    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }
      .download-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="toolbar">
      <button type="button" id="theme-toggle">Dark mode</button>
    </div>
    <h1>String Visualiser</h1>
    <p class="lede">Inspect every rune in your input and see the UTF-8 bytes, code points, and HTML entities.</p>
  </header>

  <form id="visualise-form">
    <div>
      <label for="input-text">Input text</label>
      <textarea id="input-text" name="input" rows="3" placeholder="Try emoji or mixed-language strings"></textarea>
      <small class="field-helper" id="input-hint">Enter the string you want to analyse. Reverse/byte parsing will arrive in later stages.</small>
    </div>
    <div>
      <label for="mode-select">Input mode</label>
      <select id="mode-select" name="mode">
        <option value="text">Plain text</option>
        <option value="codepoints">Code points (e.g., U+0041 0x0042)</option>
        <option value="bytes">Bytes (e.g., 0xF0 0x9F 0x92 0x96)</option>
      </select>
      <small class="field-helper" id="mode-hint">Switch to code points or bytes to convert into readable text.</small>
    </div>
    <button type="submit">Visualise</button>
  </form>

  <div id="status" class="status hidden"></div>

  <section id="results-section" class="hidden">
    <h2>Results</h2>
    <div class="results-card">
      <div class="download-actions">
        <button type="button" id="download-json" data-download="json" disabled>Download JSON</button>
        <button type="button" id="download-csv" data-download="csv" disabled>Download CSV</button>
      </div>
      <div class="table-wrapper">
        <table class="results-table">
          <thead>
            <tr>
              <th>Character</th>
              <th>Code Point</th>
              <th>UTF-8 Hex</th>
              <th>UTF-8 Dec</th>
              <th>UTF-8 Binary</th>
              <th>HTML Entities</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    const form = document.getElementById('visualise-form');
    const inputText = document.getElementById('input-text');
    const inputHint = document.getElementById('input-hint');
    const modeSelect = document.getElementById('mode-select');
    const statusBox = document.getElementById('status');
    const resultsSection = document.getElementById('results-section');
    const resultsBody = document.getElementById('results-body');
    const themeToggle = document.getElementById('theme-toggle');
    const downloadButtons = document.querySelectorAll('[data-download]');

    const modePlaceholders = {
      text: 'Try emoji or mixed-language strings',
      codepoints: 'Example: U+0041 0x1F60A or decimal values separated by spaces',
      bytes: 'Example: 0xF0 0x9F 0x98 0x8A or 240 159 152 138',
    };

    const setStatus = (message, type = 'info') => {
      if (!message) {
        statusBox.classList.add('hidden');
        statusBox.textContent = '';
        return;
      }
      statusBox.textContent = message;
      statusBox.className = 'status';
      if (type === 'error') {
        statusBox.classList.add('error');
      } else if (type === 'success') {
        statusBox.classList.add('success');
      }
      statusBox.classList.remove('hidden');
    };

    const toggleDownloads = (disabled) => {
      downloadButtons.forEach((btn) => {
        btn.disabled = disabled;
      });
    };

    const createCopyCell = (lines, copyValue) => {
      const td = document.createElement('td');
      const wrapper = document.createElement('div');
      wrapper.className = 'cell-content';
      lines.forEach((line, idx) => {
        const el = idx === 0 ? document.createElement('span') : document.createElement('small');
        el.textContent = line;
        wrapper.appendChild(el);
      });
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'copy-btn';
      button.dataset.copy = copyValue;
      button.textContent = 'Copy';
      td.appendChild(wrapper);
      td.appendChild(button);
      return td;
    };

    const renderResults = (items) => {
      resultsBody.innerHTML = '';
      if (items.length === 0) {
        resultsSection.classList.add('hidden');
        toggleDownloads(true);
        return;
      }
      items.forEach((item) => {
        const row = document.createElement('tr');
        row.appendChild(createCopyCell([item.Character], item.Character));
        row.appendChild(
          createCopyCell(
            [item.CodePointHex, `Dec ${item.CodePointDec}`],
            `${item.CodePointHex} (${item.CodePointDec})`,
          ),
        );
        row.appendChild(createCopyCell([item.UTF8BytesHex.join(', ')], item.UTF8BytesHex.join(' ')));
        row.appendChild(createCopyCell([item.UTF8BytesDec.join(', ')], item.UTF8BytesDec.join(' ')));
        row.appendChild(createCopyCell([item.UTF8BytesBinary.join(', ')], item.UTF8BytesBinary.join(' ')));
        row.appendChild(
          createCopyCell(
            [item.HTMLEntityDecimal, item.HTMLEntityHex],
            `${item.HTMLEntityDecimal} ${item.HTMLEntityHex}`,
          ),
        );
        resultsBody.appendChild(row);
      });
      resultsSection.classList.remove('hidden');
      toggleDownloads(false);
    };

    const applyModeHint = () => {
      const mode = modeSelect.value;
      inputText.placeholder = modePlaceholders[mode];
      if (mode === 'text') {
        inputHint.textContent = 'Enter plain text to inspect each rune in your string.';
      } else if (mode === 'codepoints') {
        inputHint.textContent = 'Provide code point tokens like U+0041 or decimal numbers separated by spaces.';
      } else {
        inputHint.textContent = 'Provide byte tokens (hex, binary, or decimal) separated by spaces.';
      }
    };

    applyModeHint();

    modeSelect.addEventListener('change', () => {
      applyModeHint();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const value = inputText.value.trim();
      if (!value) {
        setStatus('Please enter text to visualise.', 'error');
        resultsSection.classList.add('hidden');
        return;
      }
      form.querySelector('button').disabled = true;
      setStatus('Analyzing...');
      try {
        const response = await fetch('/api/visualise', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input: value, mode: modeSelect.value }),
        });
        if (!response.ok) {
          const message = (await response.text()) || 'Server returned an error.';
          throw new Error(message);
        }
        const data = await response.json();
        renderResults(data.items || []);
        setStatus(`Showing ${data.items.length} result(s).`, 'success');
      } catch (err) {
        renderResults([]);
        setStatus(err.message, 'error');
      } finally {
        form.querySelector('button').disabled = false;
      }
    });

    const downloadResults = async (format) => {
      const params = new URLSearchParams({
        format,
        input: inputText.value,
        mode: modeSelect.value,
      });
      try {
        const response = await fetch(`/api/download?${params.toString()}`);
        if (!response.ok) {
          const message = (await response.text()) || 'Unable to download the requested format.';
          throw new Error(message);
        }
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = format === 'csv' ? 'visualiser.csv' : 'visualiser.json';
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        setStatus(err.message, 'error');
      }
    };

    downloadButtons.forEach((btn) => {
      btn.addEventListener('click', () => downloadResults(btn.dataset.download));
    });

    resultsBody.addEventListener('click', async (event) => {
      const button = event.target.closest('.copy-btn');
      if (!button) return;
      const value = button.dataset.copy || '';
      try {
        await navigator.clipboard.writeText(value);
        const original = button.textContent;
        button.textContent = 'Copied!';
        button.disabled = true;
        setTimeout(() => {
          button.textContent = original;
          button.disabled = false;
        }, 1200);
      } catch (err) {
        setStatus('Clipboard copy failed. Try copying manually.', 'error');
      }
    });

    const THEME_KEY = 'visualiser-theme';
    const applyTheme = (mode) => {
      document.body.setAttribute('data-theme', mode);
      themeToggle.textContent = mode === 'dark' ? 'Light mode' : 'Dark mode';
    };
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');

    themeToggle.addEventListener('click', () => {
      const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      localStorage.setItem(THEME_KEY, next);
    });
  </script>
</body>
</html>
